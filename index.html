<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebGen AI | أنشئ موقعك في 60 ثانية</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <style>
        /* Custom Styles and Colors (Cohesive Theme) */
        :root {
            --primary-blue: #3B82F6; /* Indigo/Blue */
            --secondary-purple: #9333EA; /* Deep Purple */
            --light-blue: #E0E7FF; /* Blue-100 */
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f6f9; /* Soft background */
            color: #1F2937;
        }
        /* Gradient for CTA and Highlights */
        .cta-gradient {
            background-image: linear-gradient(to right, var(--primary-blue), var(--secondary-purple));
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .cta-gradient:hover {
            transform: scale(1.03);
            box-shadow: 0 10px 20px -5px rgba(59, 130, 246, 0.5);
        }

        /* App UI Styles */
        .app-container {
            /* Max width for responsive design (looks like a phone app on desktop) */
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            background-color: white; /* Clean white background */
        }
        .app-input {
            border: 2px solid #E5E7EB;
            transition: border-color 0.3s, box-shadow 0.3s;
            background-color: #F9FAFB;
        }
        .app-input:focus {
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 1px rgba(59, 130, 246, 0.5);
            background-color: white;
        }
        /* Progress Bar Styling */
        .step-indicator {
            height: 6px;
            background-color: #E5E7EB;
            border-radius: 9999px;
            overflow: hidden;
        }
        .step-indicator-progress {
            background-image: linear-gradient(to right, #3B82F6, #9333EA);
            transition: width 0.5s ease-in-out;
            height: 100%;
        }
        /* Selectable Card Styling (Stage 2) */
        .app-card-select {
            border: 2px solid #F3F4F6;
            transition: all 0.2s;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }
        .app-card-select:hover {
            border-color: #D1D5DB;
        }
        .app-card-select.selected {
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 3px var(--light-blue);
            background-color: #F8FAFF;
        }
        /* Custom Switch Styling */
        .switch-toggle:checked {
            background-color: var(--primary-blue);
        }

        /* Input Collapse Animation */
        .input-collapse {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease-in-out, opacity 0.4s ease-in-out;
            opacity: 0;
            margin-top: 0;
        }
        .input-collapse.expanded {
            max-height: 100px; /* Adjust based on content height */
            opacity: 1;
            margin-top: 1rem;
        }

        /* Progress Circle styles for the app UI */
        .progress-ring {
            width: 150px;
            height: 150px;
        }
        .progress-ring__circle {
            transition: stroke-dashoffset 0.1s linear; /* Use linear for loading simulation */
            transform: rotate(-90deg);
            transform-origin: 50% 50%;
        }
        
        /* Final Result Section Styles */
        #final-result-section {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 24px;
        }
    </style>
</head>
<body class="antialiased">

    <div id="landing-page" class="max-w-md mx-auto">
        <header class="sticky top-0 z-10 bg-white shadow-sm">
            <div class="p-4 flex justify-between items-center">
                <div class="text-2xl font-extrabold cta-gradient bg-clip-text text-transparent">WebGen AI</div>
                <a href="#pricing-section" class="text-sm font-semibold text-gray-700 hover:text-indigo-600 transition flex items-center">
                    <i data-lucide="tag" class="w-4 h-4 ml-1"></i>
                    الأسعار
                </a>
            </div>
        </header>

        <main class="p-4 space-y-12 pb-16">
            <section class="text-center pt-8">
                <span class="inline-block px-3 py-1 text-xs font-semibold rounded-full bg-indigo-100 text-indigo-700 mb-4">
                    جديد! إنشاء المواقع بالذكاء الاصطناعي
                </span>
                <h1 class="text-4xl font-extrabold leading-tight mb-4">
                    أنشئ موقعك المتكامل<br> في أقل من دقيقة.
                </h1>
                <p class="text-xl text-gray-600 mb-8">
                    صفحة هبوط، متجر، أو معرض أعمال. لا كود. لا تعقيد. فقط اضغط وابدأ البيع.
                </p>
                
                <button onclick="startApp()" class="w-full inline-flex items-center justify-center py-4 text-white text-lg font-bold rounded-xl cta-gradient shadow-lg">
                    <i data-lucide="rocket" class="w-6 h-6 ml-2"></i>
                    ابدأ مجانًا الآن!
                </button>
            </section>
            
            <section>
                <h2 class="text-2xl font-bold text-center mb-6">سرعة لا تصدق في الإنشاء</h2>
                <div class="w-64 h-96 mx-auto rounded-3xl overflow-hidden shadow-2xl relative bg-white border-4 border-gray-100">
                    <img src="https://placehold.co/200x350/3B82F6/FFFFFF?text=AI+Builder+Preview" alt="واجهة تطبيق WebGen AI على الهاتف" class="w-full h-full object-cover">
                    <span class="absolute top-2 left-2 px-2 py-1 bg-white text-gray-800 text-xs rounded-full shadow">شاهد الفيديو</span>
                </div>
                <p class="text-center text-sm text-gray-500 mt-4 flex items-center justify-center">
                    <i data-lucide="check-circle" class="w-4 h-4 ml-1 text-green-500"></i>
                    مواقع مُصممة لجمهور تيك توك.
                </p>
            </section>

            <section class="space-y-6">
                <h2 class="text-2xl font-bold text-center mb-6">لماذا WebGen AI هو خيارك الأفضل؟</h2>
                <div class="flex items-start space-x-4 space-x-reverse p-4 bg-white rounded-xl shadow-md">
                    <div class="p-3 rounded-full bg-indigo-100 text-indigo-600">
                        <i data-lucide="dollar-sign" class="w-6 h-6"></i>
                    </div>
                    <div>
                        <h3 class="font-semibold text-lg">تحكم كامل في الشراء</h3>
                        <p class="text-gray-500 text-sm">اجعل عميلك يشتري عبر رابط مباشر أو يرسل لك رسالة على واتساب لإتمام الطلب.</p>
                    </div>
                </div>
                <div class="flex items-start space-x-4 space-x-reverse p-4 bg-white rounded-xl shadow-md">
                    <div class="p-3 rounded-full bg-indigo-100 text-indigo-600">
                        <i data-lucide="zap" class="w-6 h-6"></i>
                    </div>
                    <div>
                        <h3 class="font-semibold text-lg">جاهز للنشر الفوري</h3>
                        <p class="text-gray-500 text-sm">موقع مُحسّن لمحركات البحث (SEO) ويعمل بسرعة البرق على كل الهواتف.</p>
                    </div>
                </div>
            </section>

            <section id="pricing-section" class="text-center bg-indigo-50 p-6 rounded-xl">
                 <h3 class="text-xl font-bold mb-4">خطوتك الأولى نحو المبيعات تبدأ الآن!</h3>
                 <button onclick="startApp()" class="w-full py-4 text-white text-lg font-bold rounded-xl cta-gradient shadow-lg">
                    <i data-lucide="play" class="w-6 h-6 ml-2"></i>
                    ابدأ رحلتك الآن
                 </button>
            </section>
        </main>

        <footer class="max-w-md mx-auto text-center py-6 text-sm text-gray-500 border-t mt-8">
            <p>© 2025 WebGen AI. جميع الحقوق محفوظة.</p>
            <div class="flex justify-center space-x-4 space-x-reverse mt-4 text-xs">
                <a href="#" class="hover:text-indigo-600">سياسة الخصوصية</a>
                <span>•</span>
                <a href="#" class="hover:text-indigo-600">شروط الاستخدام</a>
            </div>
        </footer>
    </div>

    <div id="webgen-app-ui" class="max-w-md mx-auto w-full hidden app-container shadow-2xl">
        <header class="sticky top-0 z-20 bg-white p-4 border-b border-gray-100">
            <div class="flex justify-between items-center mb-4">
                <button onclick="goBack()" class="text-gray-600 hover:text-indigo-600 transition hidden p-1">
                    <i data-lucide="chevron-right" class="w-6 h-6"></i>
                </button>
                <div class="text-xl font-bold cta-gradient bg-clip-text text-transparent">WebGen AI Builder</div>
                <div class="w-6 h-6"></div> 
            </div>
            
            <div class="flex justify-between text-xs font-semibold text-gray-500 mb-2">
                <span id="step-title-1" class="text-indigo-600">1. الأساسيات</span>
                <span id="step-title-2">2. الفئات</span>
                <span id="step-title-3">3. المنتجات</span>
                <span id="step-title-4">4. النشر</span>
            </div>
            <div class="step-indicator">
                <div id="app-progress-bar" class="step-indicator-progress w-1/4"></div>
            </div>
        </header>

        <section id="app-stage-1" class="p-6 flex flex-col justify-between flex-grow">
            <div>
                <h2 class="text-2xl font-bold mb-4 text-gray-800">أولاً: معلومات موقعك الأساسية</h2>
                <p class="text-gray-500 mb-8">سنستخدم هذه البيانات لإنشاء محتوى موقعك.</p>
                <form id="stage-1-form" class="space-y-6">
                    <div>
                        <label for="app-site-name" class="block text-sm font-medium text-gray-700">اسم الموقع أو النشاط *</label>
                        <input type="text" id="app-site-name" class="mt-1 block w-full rounded-xl p-3 app-input" placeholder="مثال: متجر الجمال السريع" required>
                    </div>
                    <div>
                        <label for="app-website-type" class="block text-sm font-medium text-gray-700">نوع الموقع الذي تريد إنشائه *</label>
                        <select id="app-website-type" class="mt-1 block w-full rounded-xl p-3 app-input appearance-none" required>
                            <option value="" disabled selected>اختر نوع الموقع</option>
                            <option value="Affiliate">صفحة لروابط التسويق بالعمولة</option>
                            <option value="Products">متجر لعرض وبيع منتجاتي</option>
                            <option value="Showcase">صفحة لعرض خدماتي أو معرض أعمال</option>
                        </select>
                    </div>

                    <div class="space-y-4 pt-4 border-t border-gray-200">
                        <h3 class="text-lg font-semibold text-gray-700">ربط روابط التواصل (للتواصل السريع)</h3>
                        
                        <div class="flex justify-between items-center bg-white p-4 rounded-xl shadow-sm border">
                            <label class="text-base text-gray-700 flex items-center">
                                <i data-lucide="instagram" class="w-5 h-5 ml-3 text-pink-500"></i>
                                انستغرام
                            </label>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" data-link-id="instagram-link-container" data-input-id="instagram-link" onchange="toggleLinkField(this)" class="sr-only peer">
                                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-indigo-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border after:border-gray-300 after:rounded-full after:h-5 after:w-5 after:transition-all switch-toggle"></div>
                            </label>
                        </div>
                        <div id="instagram-link-container" class="input-collapse">
                            <input type="url" id="instagram-link" placeholder="الرابط الكامل لحساب انستغرام" class="w-full rounded-xl p-3 app-input">
                        </div>

                        <div class="flex justify-between items-center bg-white p-4 rounded-xl shadow-sm border">
                            <label class="text-base text-gray-700 flex items-center">
                                <i data-lucide="message-square-text" class="w-5 h-5 ml-3 text-green-500"></i>
                                واتساب
                            </label>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" data-link-id="whatsapp-link-container" data-input-id="whatsapp-number" onchange="toggleLinkField(this)" class="sr-only peer">
                                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-indigo-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border after:border-gray-300 after:rounded-full after:h-5 after:w-5 after:transition-all switch-toggle"></div>
                            </label>
                        </div>
                         <div id="whatsapp-link-container" class="input-collapse">
                            <input type="text" id="whatsapp-number" placeholder="رقم واتساب مع رمز الدولة (مثال: +9665XXXXXXXX)" class="w-full rounded-xl p-3 app-input">
                        </div>
                    </div>
                </form>
            </div>
            <button onclick="validateAndGoNext(1)" class="w-full py-4 text-white font-bold rounded-xl cta-gradient shadow-lg mt-10">التالي: اختر فئات المنتجات</button>
        </section>
        
        <section id="app-stage-2" class="p-6 flex flex-col justify-between flex-grow hidden">
            <div>
                <h2 class="text-2xl font-bold mb-4 text-gray-800">ثانياً: ما هي فئات منتجاتك الرئيسية؟</h2>
                <p class="text-gray-500 mb-8">اختر الفئات التي تتحدث عنها على تيك توك لتصميم الأقسام. (اختياري)</p>
                <div id="category-cards" class="grid grid-cols-2 gap-4">
                    <div data-category="ملابس/أزياء" onclick="selectCard(this)" class="app-card-select p-4 rounded-xl flex flex-col items-center cursor-pointer bg-white">
                        <i data-lucide="t-shirt" class="w-10 h-10 mb-2 text-indigo-500"></i>
                        <span class="text-sm font-medium text-gray-800">ملابس/أزياء</span>
                    </div>
                    <div data-category="جمال/عناية" onclick="selectCard(this)" class="app-card-select p-4 rounded-xl flex flex-col items-center cursor-pointer bg-white">
                        <i data-lucide="sparkles" class="w-10 h-10 mb-2 text-pink-500"></i>
                        <span class="text-sm font-medium text-gray-800">جمال/عناية</span>
                    </div>
                    <div data-category="مأكولات/حلويات" onclick="selectCard(this)" class="app-card-select p-4 rounded-xl flex flex-col items-center cursor-pointer bg-white selected">
                        <i data-lucide="cake" class="w-10 h-10 mb-2 text-yellow-500"></i>
                        <span class="text-sm font-medium text-gray-800">مأكولات/حلويات</span>
                    </div>
                    <div data-category="إلكترونيات" onclick="selectCard(this)" class="app-card-select p-4 rounded-xl flex flex-col items-center cursor-pointer bg-white">
                        <i data-lucide="monitor" class="w-10 h-10 mb-2 text-green-500"></i>
                        <span class="text-sm font-medium text-gray-800">إلكترونيات</span>
                    </div>
                    <div data-category="منزل/ديكور" onclick="selectCard(this)" class="app-card-select p-4 rounded-xl flex flex-col items-center cursor-pointer bg-white">
                        <i data-lucide="home" class="w-10 h-10 mb-2 text-blue-500"></i>
                        <span class="text-sm font-medium text-gray-800">منزل/ديكور</span>
                    </div>
                    <div data-category="أخرى" onclick="selectCard(this)" class="app-card-select p-4 rounded-xl flex flex-col items-center cursor-pointer bg-white">
                        <i data-lucide="ellipsis" class="w-10 h-10 mb-2 text-gray-500"></i>
                        <span class="text-sm font-medium text-gray-800">أخرى</span>
                    </div>
                </div>
            </div>
            <button onclick="validateAndGoNext(2)" class="w-full py-4 text-white font-bold rounded-xl cta-gradient shadow-lg mt-10">التالي: إضافة المنتجات</button>
        </section>

        <section id="app-stage-3" class="p-6 flex flex-col justify-between flex-grow hidden">
            <div>
                <h2 class="text-2xl font-bold mb-4 text-gray-800">ثالثاً: تفاصيل المنتج (الأهم للمبيعات)</h2>
                <p class="text-gray-500 mb-8">املأ بيانات المنتج لجذب انتباه العميل. (نركز على منتج واحد للتجربة)</p>
                <div id="product-list" class="space-y-6">
                    <div class="p-5 border border-gray-200 rounded-xl shadow-lg bg-white space-y-4">
                        
                        <div class="space-y-2">
                             <label for="product-image-url-1" class="block text-sm font-medium text-gray-700">رابط الصورة العامة للمنتج (URL):</label>
                             <input type="url" id="product-image-url-1" placeholder="https://example.com/product-image.jpg" class="w-full rounded-xl p-3 app-input" required>
                        </div>
                        
                        <input type="text" id="product-title-1" placeholder="عنوان المنتج (جذاب ومختصر)" class="w-full rounded-xl p-3 app-input" required>
                        <textarea id="product-desc-1" placeholder="وصف المنتج (قوي ومقنع)" rows="3" class="w-full rounded-xl p-3 app-input"></textarea>
                        
                        <div class="flex space-x-4 space-x-reverse">
                            <input type="text" id="product-price-1" placeholder="السعر" class="w-1/3 rounded-xl p-3 app-input" value="20">
                            <select id="product-currency-1" class="w-2/3 rounded-xl p-3 app-input appearance-none">
                                <option>ريال سعودي (SAR)</option>
                                <option>دولار أمريكي (USD)</option>
                                <option>درهم إماراتي (AED)</option>
                                <option>جنيه مصري (EGP)</option>
                                <option>دينار كويتي (KWD)</option>
                            </select>
                        </div>
                        
                        <div class="pt-2">
                            <h4 class="text-md font-semibold text-gray-700 mb-2">كيف يتم الشراء؟</h4>
                            <div class="flex justify-between items-center p-3 rounded-lg border bg-blue-50">
                                <label class="text-base text-gray-700 flex items-center">
                                    <i data-lucide="external-link" class="w-5 h-5 ml-2 text-blue-600"></i>
                                    رابط شراء مباشر (مثل أمازون/سلة)
                                </label>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" data-link-id="product-link-container" data-input-id="product-buy-link-1" onchange="toggleLinkField(this)" class="sr-only peer">
                                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-indigo-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border after:border-gray-300 after:rounded-full after:h-5 after:w-5 after:transition-all switch-toggle"></div>
                                </label>
                            </div>
                        </div>
                        <div id="product-link-container" class="input-collapse">
                            <input type="url" id="product-buy-link-1" placeholder="الرابط المباشر لصفحة المنتج" class="w-full rounded-xl p-3 app-input">
                        </div>
                    </div>
                </div>
                
                <button class="text-indigo-600 font-medium mt-6 flex items-center p-2 rounded-lg hover:bg-indigo-50 transition hidden">
                    <i data-lucide="plus-circle" class="w-5 h-5 ml-2"></i>
                    أضف منتجًا آخر (غير مفعل حاليا)
                </button>
            </div>
            <button onclick="publishSite()" id="publish-button-3" class="w-full py-4 text-white font-bold rounded-xl cta-gradient shadow-lg mt-10">الخطوة الأخيرة: أنشئ موقعي!</button>
        </section>

        <section id="app-stage-4" class="p-6 flex flex-col justify-start items-center flex-grow hidden">
            <div id="loading-state" class="w-full flex flex-col justify-start items-center">
                <div class="w-full text-center">
                    <h2 class="text-3xl font-bold mt-16 mb-6 text-gray-800">جاري إنشاء موقعك ونشره الآن...</h2>
                    <p class="text-gray-500 mb-12">يرجى الانتظار (40 ثانية)، الذكاء الاصطناعي يعمل على البنية التحتية.</p>
                </div>
                
                <div class="progress-ring relative flex items-center justify-center mb-10">
                    <svg class="progress-ring" viewBox="0 0 100 100">
                        <circle class="progress-ring__circle" stroke="#E5E7EB" stroke-width="8" fill="transparent" r="46" cx="50" cy="50"/>
                        <circle id="app-progress-indicator" class="progress-ring__circle" stroke="url(#progress-gradient)" stroke-width="8" fill="transparent" r="46" cx="50" cy="50" style="stroke-dasharray: 289; stroke-dashoffset: 289;"/>
                        <defs>
                            <linearGradient id="progress-gradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                <stop offset="0%" style="stop-color:#3B82F6;stop-opacity:1" />
                                <stop offset="100%" style="stop-color:#9333EA;stop-opacity:1" />
                            </linearGradient>
                        </defs>
                    </svg>
                    <span id="app-progress-percent" class="absolute text-5xl font-extrabold cta-gradient bg-clip-text text-transparent">0%</span>
                </div>

                <div id="loading-status-list" class="w-full space-y-4 max-w-xs text-right">
                    </div>
            </div>

            <div id="final-result-section" class="hidden">
                <i data-lucide="award" class="w-20 h-20 text-yellow-500 mb-4"></i>
                <h2 class="text-3xl font-bold text-gray-800 mb-2">تهانينا! موقعك جاهز!</h2>
                
                <div class="my-6 w-full max-w-sm p-4 bg-indigo-50 border-2 border-indigo-200 rounded-xl shadow-inner">
                    <p class="text-sm font-medium text-gray-600 mb-2">رابط موقعك (جاهز للربط على منصاتك):</p>
                    <a id="site-link" href="#" target="_blank" class="text-lg font-bold text-indigo-700 break-all hover:underline">سيتم وضع رابط موقعك هنا بعد النشر</a>
                    </div>

                <div class="bg-red-50 text-red-700 p-3 rounded-lg w-full max-w-sm mb-6 flex items-center justify-center">
                    <i data-lucide="timer" class="w-5 h-5 ml-2"></i>
                    <span id="delete-timer" class="font-bold">الموقع سيحذف تلقائيًا بعد 05:00</span>
                </div>

                <div class="bg-gray-800 text-white p-5 rounded-xl w-full max-w-sm shadow-2xl space-y-3">
                    <h3 class="text-xl font-bold">حافظ على موقعك وميزاتك!</h3>
                    <p class="text-sm">
                        هذا الموقع مؤقت. يمكنك الدفع **20 دولارًا شهريًا** فقط لتحصل على:
                        <ul class="list-disc list-inside mt-2 text-sm text-gray-300">
                            <li>نطاق دائم (Domain)</li>
                            <li>تحليلات متقدمة للمبيعات</li>
                            <li>دعم واتساب 24/7</li>
                        </ul>
                    </p>
                    <button class="w-full py-3 text-lg font-bold rounded-lg bg-yellow-400 text-gray-900 hover:bg-yellow-500 transition">
                        الترقية والدفع الآن
                    </button>
                </div>
            </div>
        </section>
    </div>

    <script>
        lucide.createIcons();

        // Landing Page / App UI interaction
        const landingPage = document.getElementById('landing-page');
        const webgenAppUI = document.getElementById('webgen-app-ui');
        const appStages = ['app-stage-1', 'app-stage-2', 'app-stage-3', 'app-stage-4'];
        const stepTitles = ['step-title-1', 'step-title-2', 'step-title-3', 'step-title-4'];
        const progressBar = document.getElementById('app-progress-bar');
        let currentAppStage = 1;

        // Timer variables for stage 4 completion
        let deleteTimerInterval;

        // --- Core App Navigation ---
        function startApp() {
            landingPage.classList.add('hidden');
            webgenAppUI.classList.remove('hidden');
            nextAppStage(1); // Start at stage 1
        }

        function hideAllAppStages() {
            appStages.forEach(id => {
                document.getElementById(id).classList.add('hidden');
            });
        }

        function updateProgressBar(stageNumber) {
            const widthPercentage = (stageNumber / appStages.length) * 100;
            progressBar.style.width = widthPercentage + '%';
            
            stepTitles.forEach((id, index) => {
                const stepElement = document.getElementById(id);
                if (index < stageNumber) {
                    stepElement.classList.remove('text-gray-500');
                    stepElement.classList.add('text-indigo-600');
                } else {
                    stepElement.classList.remove('text-indigo-600');
                    stepElement.classList.add('text-gray-500');
                }
            });
        }

        function nextAppStage(stageNumber) {
            hideAllAppStages();
            const nextId = 'app-stage-' + stageNumber;
            document.getElementById(nextId).classList.remove('hidden');
            currentAppStage = stageNumber;
            updateAppHeaderVisibility();
            updateProgressBar(stageNumber);
        }

        function goBack() {
            // Stop timer if user navigates back from final result screen
            clearInterval(deleteTimerInterval);
            if (currentAppStage > 1) {
                nextAppStage(currentAppStage - 1);
            } else {
                // If on stage 1, go back to landing page
                webgenAppUI.classList.add('hidden');
                landingPage.classList.remove('hidden');
            }
        }

        function updateAppHeaderVisibility() {
            const backButton = webgenAppUI.querySelector('header button');
            if (currentAppStage > 1) {
                backButton.classList.remove('hidden');
            } else {
                backButton.classList.add('hidden');
            }
        }
        
        // --- Input Validation & Navigation ---
        function validateAndGoNext(currentStage) {
            let isValid = true;
            
            // Basic validation for Stage 1 required fields
            if (currentStage === 1) {
                const siteName = document.getElementById('app-site-name');
                const siteType = document.getElementById('app-website-type');
                if (!siteName.value.trim() || !siteType.value) {
                    alert('يرجى ملء جميع الحقول الأساسية المطلوبة في هذه المرحلة.');
                    isValid = false;
                }
            }
            
            if (isValid) {
                nextAppStage(currentStage + 1);
            }
        }
        
        // --- Data Collection & Publishing ---
        function collectAllFormData() {
            const data = {};
            
            // Stage 1 Data
            data.site_name = document.getElementById('app-site-name').value.trim();
            data.site_type = document.getElementById('app-website-type').value;
            data.instagram_link = document.getElementById('instagram-link').value.trim();
            
            const whatsappNumber = document.getElementById('whatsapp-number').value.trim();
            data.whatsapp_link = whatsappNumber ? `https://wa.me/${whatsappNumber.replace('+', '')}` : ''; // Format for wa.me link

            // Stage 2 Data (Selected Category - simplified to one)
            const selectedCategory = document.querySelector('#category-cards .app-card-select.selected');
            data.product_category = selectedCategory ? selectedCategory.getAttribute('data-category') : 'عام';

            // Stage 3 Data (Single Product)
            data.product_title = document.getElementById('product-title-1').value.trim();
            data.product_desc = document.getElementById('product-desc-1').value.trim();
            
            const price = document.getElementById('product-price-1').value.trim();
            const currency = document.getElementById('product-currency-1').value.split(' ')[0]; // SAR, USD, etc.
            data.product_price = price ? `${price} ${currency}` : 'السعر غير محدد';
            
            data.product_image_url = document.getElementById('product-image-url-1').value.trim();
            data.buy_link = document.getElementById('product-buy-link-1').value.trim();
            
            return data;
        }

        function publishSite() {
            // CRITICAL: Validate Stage 3 required fields
            const productTitle = document.getElementById('product-title-1').value.trim();
            const imageUrl = document.getElementById('product-image-url-1').value.trim();

            if (!productTitle || !imageUrl) {
                alert('يرجى ملء عنوان المنتج ورابط الصورة العامة للمنتج (مطلوب).');
                return;
            }

            const payload = collectAllFormData();
            nextAppStage(4); // Move to the loading stage
            
            const publishButton = document.getElementById('publish-button-3');
            
            // Start simulation and API call
            simulateLoading();

            const apiUrl = 'http://0.0.0.0:5000/api/publish';
            
            fetch(apiUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(payload)
            })
            .then(response => response.json())
            .then(result => {
                if (result.status === 'success') {
                    // Update the final result section with the real link
                    const siteLinkElement = document.getElementById('site-link');
                    siteLinkElement.href = result.url;
                    siteLinkElement.textContent = result.url;
                } else {
                    // If the API failed (e.g., key failed, network error), we still finish the simulation
                    console.error('API Error:', result.message);
                    // CRITICAL: We need a mechanism to show the error on the final stage
                    document.getElementById('final-result-section').innerHTML = `
                        <i data-lucide="x-circle" class="w-20 h-20 text-red-500 mb-4"></i>
                        <h2 class="text-3xl font-bold text-gray-800 mb-2">فشل النشر!</h2>
                        <p class="text-red-600 mt-4">${result.message || 'خطأ غير معروف في خادم النشر.'}</p>
                        <button onclick="goBack()" class="w-full py-3 mt-6 text-white font-bold rounded-xl bg-indigo-600 hover:bg-indigo-700">العودة وإعادة المحاولة</button>
                    `;
                    lucide.createIcons();
                }
            })
            .catch(error => {
                // If fetch fails (e.g., server not running)
                console.error('Network Error:', error);
                document.getElementById('final-result-section').innerHTML = `
                    <i data-lucide="cloud-off" class="w-20 h-20 text-red-500 mb-4"></i>
                    <h2 class="text-3xl font-bold text-gray-800 mb-2">فشل النشر!</h2>
                    <p class="text-red-600 mt-4">تعذر الاتصال بخادم الـ API. تأكد من تشغيل <code>python api_server.py</code>.</p>
                    <button onclick="goBack()" class="w-full py-3 mt-6 text-white font-bold rounded-xl bg-indigo-600 hover:bg-indigo-700">العودة وإعادة المحاولة</button>
                `;
                lucide.createIcons();
            });
        }
        
        // --- Final Result Logic ---
        function startDeleteTimer() {
            const duration = 5 * 60; // 5 minutes in seconds
            let timer = duration;
            const display = document.getElementById('delete-timer');

            function updateTimer() {
                const minutes = Math.floor(timer / 60);
                const seconds = timer % 60;
                
                // Format the time as MM:SS
                const formattedTime = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                display.textContent = `الموقع سيحذف تلقائيًا بعد ${formattedTime}`;

                if (--timer < 0) {
                    timer = 0;
                    clearInterval(deleteTimerInterval);
                    display.textContent = 'تم حذف الموقع تلقائيًا.';
                    // Optional: redirect user or show a "deleted" screen
                }
            }

            // Clear any existing interval before starting a new one
            clearInterval(deleteTimerInterval); 
            
            // Set the interval to update every second
            deleteTimerInterval = setInterval(updateTimer, 1000);
            updateTimer(); // Initial call to display immediately
        }

        function showFinalResult() {
            document.getElementById('loading-state').classList.add('hidden');
            document.getElementById('final-result-section').classList.remove('hidden');
            // Check if the content is the success message before starting the timer
            const isSuccess = document.getElementById('final-result-section').querySelector('i[data-lucide="award"]');
            if (isSuccess) {
                startDeleteTimer();
            }
        }
        
        // --- Stage 1 & 3: Link Field Toggle Animation ---
        function toggleLinkField(checkbox) {
            const containerId = checkbox.getAttribute('data-link-id');
            const container = document.getElementById(containerId);
            if (checkbox.checked) {
                container.classList.add('expanded');
            } else {
                container.classList.remove('expanded');
            }
        }

        // --- Stage 2: Card Selection Logic ---
        function selectCard(element) {
            element.classList.toggle('selected');
        }

        // --- Stage 4: 40-Second Loading Simulation ---
        const loadingSteps = [
            { title: "جاري تحليل مدخلاتك واختيار أفضل بنية تصميمية", duration: 7000 },
            { title: "بدء كتابة محتوى الموقع الأساسي ومقاطع الفيديو (AI Content)", duration: 8000 },
            { title: "إعداد معلومات المنتج: العنوان والرابط والسعر", duration: 5000 },
            { title: "إعداد تحسين محركات البحث (SEO) للمحتوى", duration: 6000 },
            { title: "تكوين شهادة SSL وحماية الموقع", duration: 4000 },
            { title: "نشر الموقع على GitHub Pages والحصول على الرابط النهائي", duration: 10000 }
        ];
        const totalDuration = 40000; // 40 seconds total

        function simulateLoading() {
            const radius = 46;
            const totalCircumference = 2 * Math.PI * radius;
            const progressIndicator = document.getElementById('app-progress-indicator');
            const progressPercentText = document.getElementById('app-progress-percent');
            const statusListContainer = document.getElementById('loading-status-list');
            
            // Initial setup
            progressIndicator.style.strokeDashoffset = totalCircumference;
            progressIndicator.style.strokeDasharray = totalCircumference;
            statusListContainer.innerHTML = '';
            
            let startTime = null;
            let stepIndex = 0;

            function updateProgress(timestamp) {
                if (!startTime) startTime = timestamp;
                const progress = timestamp - startTime;
                
                const percentage = Math.min(100, (progress / totalDuration) * 100);
                
                // 1. Update Circle and Text
                const offset = totalCircumference - percentage / 100 * totalCircumference;
                progressIndicator.style.strokeDashoffset = offset;
                progressPercentText.textContent = `${Math.floor(percentage)}%`;

                // 2. Update Status List
                if (stepIndex < loadingSteps.length) {
                    const stepCompletedAt = loadingSteps.slice(0, stepIndex + 1).reduce((sum, step) => sum + step.duration, 0);

                    if (progress >= stepCompletedAt) {
                        // Mark previous step as complete (check mark)
                        const completedStatusElement = document.getElementById(`step-${stepIndex - 1}-status`);
                        if (completedStatusElement) {
                            completedStatusElement.innerHTML = `<i data-lucide="check-circle" class="w-5 h-5 text-green-500"></i>`;
                            lucide.createIcons();
                        }

                        // Move to the next step
                        stepIndex++;

                        if (stepIndex <= loadingSteps.length) {
                            const nextStep = loadingSteps[stepIndex - 1];
                            const statusHtml = `
                                <div id="step-${stepIndex - 1}" class="flex items-center justify-between py-3 border-b border-gray-100">
                                    <span class="text-lg text-gray-700 flex items-center">
                                        <i data-lucide="zap" class="w-5 h-5 ml-2 text-indigo-500"></i>
                                        ${nextStep.title}
                                    </span>
                                    <span id="step-${stepIndex - 1}-status"><i data-lucide="loader-2" class="w-5 h-5 text-gray-400 animate-spin"></i></span>
                                </div>`;
                            // Append the new status element to the list
                            statusListContainer.innerHTML += statusHtml;
                            lucide.createIcons(); // Re-render icons for new content
                        }
                    }
                }

                if (percentage < 100) {
                    requestAnimationFrame(updateProgress);
                } else {
                    // Final state adjustments (CRITICAL: showFinalResult is here only)
                    progressPercentText.textContent = 'تم!';
                    // Final checkmark for the last step
                    const finalElement = document.getElementById(`step-${loadingSteps.length - 1}-status`);
                    if (finalElement) {
                        finalElement.innerHTML = `<i data-lucide="check-circle" class="w-5 h-5 text-green-500"></i>`;
                        lucide.createIcons();
                    }
                    showFinalResult(); 
                }
            }
            
            // Manually trigger the first step outside the loop to ensure it appears immediately
            const initialStep = loadingSteps[0];
            const initialHtml = `
                <div id="step-0" class="flex items-center justify-between py-3 border-b border-gray-100">
                    <span class="text-lg text-gray-700 flex items-center">
                        <i data-lucide="zap" class="w-5 h-5 ml-2 text-indigo-500"></i>
                        ${initialStep.title}
                    </span>
                    <span id="step-0-status"><i data-lucide="loader-2" class="w-5 h-5 text-gray-400 animate-spin"></i></span>
                </div>`;
            statusListContainer.innerHTML = initialHtml;
            lucide.createIcons();
            
            // Start the main animation loop
            requestAnimationFrame(updateProgress);
        }
        
        // Ensure initial elements are set up
        document.addEventListener('DOMContentLoaded', () => {
            // Set initial state for the progress bar
            updateProgressBar(1);
            
            // Close all collapse containers on load
            document.querySelectorAll('.input-collapse').forEach(el => {
                el.classList.remove('expanded');
            });
        });
    </script>

</body>
</html>
